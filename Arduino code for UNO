#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

// --- SCREEN SETTINGS ---
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET    -1 
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// --- HARDWARE ---
const int sensorPin = A0;   
const int buttonPin = 2;    // Button to Ground

// --- CALIBRATION (UPDATED) ---
float sensorOffset = 0; 
float k_constant = 185.0; 

// --- VARIABLES ---
unsigned long previousMillis = 0;   
float currentTidalVol = 0.0;        
float peakFlow = 0.0;               
bool isBreathing = false;           
unsigned long breathStopTimer = 0;  

// --- SETTINGS (UPDATED) ---
// CHANGED: Increased threshold to 8.0 to ignore small noise so result triggers reliably
const float FLOW_THRESHOLD = 8.0;   
const int BREATH_TIMEOUT = 1200;    // Wait 1.2 sec after flow stops before showing result

void setup() {
  Serial.begin(9600);

  // 1. Initialize Screen
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { 
    for(;;); // Halt if screen fails
  }

  // 2. Initialize Button
  pinMode(buttonPin, INPUT_PULLUP); 
   
  // 3. Calibration Screen
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(WHITE);
  display.setCursor(10, 20);
  display.println("CALIBRATING...");
  display.setCursor(10, 35);
  display.println("Ensure Flow is 0");
  display.display();
  delay(1500); 

  // 4. Calibrate Sensor
  long total = 0;
  for(int i=0; i<50; i++){
    total += analogRead(sensorPin);
    delay(10);
  }
  sensorOffset = total / 50.0;
   
  display.clearDisplay();
  previousMillis = millis(); 
}

void loop() {
  // --- TIME CALC ---
  unsigned long currentMillis = millis();
  float dt = (currentMillis - previousMillis) / 1000.0; 
  previousMillis = currentMillis;

  // --- READ SENSOR ---
  float rawValue = analogRead(sensorPin);
  float adjustedValue = rawValue - sensorOffset;
  
  // Hard zero clamp to fix "Not Holding" issue
  if (adjustedValue < 3) adjustedValue = 0; 

  // --- PHYSICS ---
  float voltage = adjustedValue * (5.0 / 1023.0);
  float pressurePa = (voltage / 0.45) * 1000.0;
   
  float flowRate = 0;
  if (pressurePa > 0) {
    flowRate = k_constant * sqrt(pressurePa / 1000.0); 
  }

  // --- BREATHING LOGIC ---
  if (flowRate > FLOW_THRESHOLD) {
    // We are breathing
    isBreathing = true;
    breathStopTimer = millis(); // Reset the stop timer
    
    if (flowRate > peakFlow) peakFlow = flowRate;
    currentTidalVol += (flowRate / 60.0) * dt;

  } else {
    // Flow is very low (user stopped blowing)
    // Check if enough time has passed to confirm breath is done
    if (isBreathing && (millis() - breathStopTimer > BREATH_TIMEOUT)) {
      
      showResultsWindow(); // <--- GO TO HOLD SCREEN
      
      // Reset after returning from hold screen
      isBreathing = false;
      currentTidalVol = 0;
      peakFlow = 0;
    }
  }

  // --- DRAW LIVE SCREEN ---
  display.clearDisplay();

  // Header
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.print("LIVE MONITOR");
  display.drawLine(0, 10, 128, 10, WHITE);

  // Flow Rate
  display.setTextSize(2);
  display.setCursor(0, 20);
  display.print(flowRate, 1); 
  display.setTextSize(1);
  display.print(" L/m");

  // Volume
  display.setCursor(0, 45);
  display.print("Vol: ");
  display.print(currentTidalVol, 2); 
  display.print(" L");

  // --- FIXED BAR GRAPH ---
  // Scale changed: 0 to 100 L/min (Better for normal breathing)
  // If flow > 100, bar stays full.
  int barFlow = flowRate;
  if (barFlow > 100) barFlow = 100; 
  
  int barWidth = map(barFlow, 0, 100, 0, 128); 
  display.fillRect(0, 56, barWidth, 8, WHITE);

  display.display();
}

// --- RESULT HOLDING FUNCTION ---
void showResultsWindow() {
  display.clearDisplay();
  
  // Title
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.print("--- RESULT ---");
  display.drawLine(0, 10, 128, 10, WHITE);

  // Peak Flow
  display.setCursor(0, 15);
  display.setTextSize(1);
  display.println("PEAK FLOW:");
  display.setTextSize(2);
  display.print(peakFlow, 0);
  display.setTextSize(1);
  display.println(" L/m");

  // Tidal Volume
  display.setCursor(0, 42);
  display.setTextSize(1);
  display.println("TIDAL VOL:");
  display.setTextSize(2);
  display.print(currentTidalVol, 2); 
  display.setTextSize(1);
  display.println(" L");

  // Reset Prompt
  display.setTextSize(1);
  display.setCursor(80, 55);
  display.print("[RESET]");

  display.display();
  
  // --- THE HOLD LOOP ---
  // The code gets stuck here intentionally until you press the button.
  // Ensure Button is connected to PIN 2 and GROUND.
  while(digitalRead(buttonPin) == HIGH) {
     // Do nothing, just wait.
  }
  
  // Button was pressed, exit loop and restart
  display.clearDisplay();
  display.setCursor(40, 30);
  display.print("RESET!");
  display.display();
  delay(500); 
  
  previousMillis = millis(); // Reset timer so volume doesn't jump
}
